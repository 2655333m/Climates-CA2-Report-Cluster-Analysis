import netCDF4 as nc
from netCDF4 import num2date
import numpy as np
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler
from scipy.cluster.hierarchy import linkage, dendrogram, fcluster


# Set working directory 
cwd = '/Users/andrewmilne/Desktop/GeoScience/Masters/Climatology/Assesments/CA2/Data'

# Load datasets
data_v10 = nc.Dataset('/Users/andrewmilne/Desktop/GeoScience/Masters/Climatology/Assesments/CA2/Data/v10.nc', 'r')
data_u10 = nc.Dataset('/Users/andrewmilne/Desktop/GeoScience/Masters/Climatology/Assesments/CA2/Data/u10.nc', 'r')
data_t2m = nc.Dataset('/Users/andrewmilne/Desktop/GeoScience/Masters/Climatology/Assesments/CA2/Data/t2m.nc', 'r')

# Extract lat/lon/time 
lat = data_v10.variables['latitude'][:]  
lon = data_v10.variables['longitude'][:]  
time = data_v10.variables['time'][:]

# Create subset for extratropical subset
ENH = (lat >= 30) & (lat <= 60)

# dictionary to store NH subsets
extratropics = {}

files = {
    "v10": data_v10,
    "u10": data_u10,
    "t2m": data_t2m
}

# Create loop of extratropical North to extraxt varibles
for varname, ds in files.items():
    field = ds.variables[varname][:]    
    extratropics[varname] = field[:, ENH, : ]
    
# Rearrange data arrays
time = num2date(ds['time'][:], ds['time'].units)

# Extract years and months via time step
years = []
months = []
for t in time:
    years.append(t.year)
    months.append(t.month)

# Create emppty mean dictionary 
mean = {}

# Convert monthly data --> winter means (December, January, February)
for varname, data in extratropics.items():
    n_time = data.shape[0]
    winter_months = [i for i, month in enumerate(months) if month in [12, 1, 2]] # Empty subset of winter, dec, jan, feb
    winter_data = data[winter_months]
    n_winters = len(winter_data) // 3
    reshape = winter_data[:n_winters*3].reshape(n_winters, 3, data.shape[1], data.shape[2])
    mean[varname] = np.mean(reshape, axis=1)

# Create data matrix
n_years = mean['t2m'].shape[0]
n_lat = mean['t2m'].shape[1] 
n_lon = mean['t2m'].shape[2]

matrix = np.zeros((n_lat * n_lon, n_years * 3))

# Convert 2d spatial gris --> 1d lsit for matrix
for i in range(n_lat): # loop throughn each lattitude
    for j in range(n_lon): # loop throughn each longitude
        idx = i * n_lon + j
        t2m_ts = mean['t2m'][:, i, j]
        u10_ts = mean['u10'][:, i, j]
        v10_ts = mean['v10'][:, i, j]
        matrix[idx, :] = np.concatenate([t2m_ts, u10_ts, v10_ts])

# Remove any missing data for clustering 
missing_data = ~np.any(np.isnan(matrix), axis = 1)
clean = matrix[missing_data, :]

# Standardization, since varibles have different units and scales (consistency)
scale = StandardScaler()
scaled_data = scale.fit_transform(clean)
print(scaled_data)

Z = linkage(scaled_data, method='ward')

# Plot dendrogram 
# Adapted from https://joernhees.de/blog/2015/08/26/scipy-hierarchical-clustering-and-dendrogram-tutorial/

plt.figure(figsize=(14, 6))
dendrogram(Z, truncate_mode='level', p=5)
plt.title(" Extratropical NH â€“ Hierarchical Clustering Dendrogram (Winter Months)")
plt.xlabel("Cluster") # Need help... what does one make this
plt.ylabel("Distance")
plt.show()

# clusters 
n_clusters = 4
labels = fcluster(Z, n_clusters, criterion='maxclust')

"""
Via the dendragram, we can identift 4 clusters.
We now move onto plotting these cluster in a cluster map
of the extratropical northern hemisphere
"""
